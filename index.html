<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ff6b35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tower Balance">
    <meta name="description" content="Physics-based tower balancing game â€“ manage center of mass and reach a new high score!">
    <title>Tower Balance</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="icons/icon-16x16.png" sizes="16x16">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
    <script src="i18n.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&display=swap');

        * {
            margin: 0; padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #ff6b35;
            --secondary: #f7931e;
            --accent: #00d9ff;
            --bg-dark: #0a0e27;
            --bg-mid: #1a1f3a;
            --text: #ffffff;
            --text-dim: #8892b0;
            --success: #00ffa3;
            --danger: #ff3366;
            --shadow: rgba(0,0,0,0.4);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* â”€â”€ Dark / Light mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        body.light-mode {
            --bg-dark: #f0f4ff;
            --bg-mid: #e0e8f8;
            --text: #0a0e27;
            --text-dim: #445577;
            --shadow: rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f1333 50%, var(--bg-mid) 100%);
            color: var(--text);
            overflow: hidden;
            touch-action: manipulation;
            height: 100vh;
            position: relative;
        }
        body.light-mode { background: linear-gradient(135deg,#f0f4ff,#e0e8f8); }

        body::before {
            content:'';
            position:absolute; width:200%; height:200%;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(255,107,53,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0,217,255,0.1) 0%, transparent 50%);
            animation:bgShift 20s ease-in-out infinite; z-index:0;
        }
        @keyframes bgShift {
            0%,100%{transform:translate(0,0)}50%{transform:translate(-10%,-10%)}
        }

        /* â”€â”€ Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #gameCanvas {
            position:absolute; top:0; left:0;
            width:100%; height:100%; z-index:1; cursor:grab;
        }
        #gameCanvas:active { cursor:grabbing; }

        /* â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #hud {
            position:absolute; top:0; left:0; width:100%;
            padding: calc(20px + var(--safe-top)) 20px 20px;
            z-index:10; pointer-events:none;
        }
        .hud-top {
            display:flex; justify-content:space-between;
            align-items:flex-start; gap:20px; flex-wrap:wrap;
        }
        .hud-panel {
            background:rgba(26,31,58,0.85); backdrop-filter:blur(10px);
            border:2px solid rgba(255,107,53,0.3); border-radius:15px;
            padding:15px 20px; box-shadow:0 8px 32px var(--shadow);
            pointer-events:auto;
        }
        .score-panel { animation:slideInTop 0.5s ease-out; }
        @keyframes slideInTop {
            from{transform:translateY(-100px);opacity:0}
            to{transform:translateY(0);opacity:1}
        }
        .score-label { font-size:14px; color:var(--text-dim); text-transform:uppercase; letter-spacing:2px; margin-bottom:5px; }
        .score-value { font-family:'Orbitron',monospace; font-size:36px; font-weight:900; color:var(--accent); text-shadow:0 0 20px rgba(0,217,255,0.5); line-height:1; }
        .info-panel { display:flex; flex-direction:column; gap:10px; min-width:180px; }
        .info-row { display:flex; justify-content:space-between; align-items:center; gap:15px; }
        .info-label { font-size:14px; color:var(--text-dim); text-transform:uppercase; }
        .info-value { font-family:'Orbitron',monospace; font-size:18px; font-weight:700; color:var(--text); }
        .timer-container { position:relative; height:8px; background:rgba(0,0,0,0.5); border-radius:10px; overflow:hidden; margin-top:10px; }
        .timer-bar { height:100%; background:linear-gradient(90deg,var(--success) 0%,var(--secondary) 50%,var(--danger) 100%); border-radius:10px; transition:width 0.1s linear; box-shadow:0 0 10px rgba(255,107,53,0.6); }

        /* â”€â”€ Version Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #versionBadge {
            position:absolute; top:calc(8px + var(--safe-top)); right:12px;
            font-size:11px; color:var(--text-dim); cursor:pointer;
            background:rgba(26,31,58,0.7); border-radius:8px; padding:3px 8px;
            z-index:20; user-select:none; border:1px solid rgba(255,107,53,0.2);
            pointer-events:auto;
        }
        #versionBadge:hover { color:var(--primary); border-color:var(--primary); }

        /* â”€â”€ Stability Meter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stability-container {
            position:absolute; bottom:calc(30px + var(--safe-bottom)); left:50%; transform:translateX(-50%);
            width:300px; max-width:90vw; z-index:10; pointer-events:none;
        }
        .stability-label { text-align:center; font-size:12px; color:var(--text-dim); margin-bottom:8px; text-transform:uppercase; letter-spacing:2px; }
        .stability-bar-container { position:relative; height:20px; background:rgba(0,0,0,0.5); border-radius:12px; border:2px solid rgba(255,107,53,0.4); overflow:hidden; }
        .stability-bar { height:100%; background:linear-gradient(90deg,var(--danger),var(--secondary),var(--success),var(--secondary),var(--danger)); transition:all 0.3s; position:relative; }
        .stability-marker { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:4px; height:100%; background:white; box-shadow:0 0 10px rgba(255,255,255,0.8); }

        /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .controls {
            position:absolute; bottom:calc(80px + var(--safe-bottom)); right:20px;
            display:flex; flex-direction:column; gap:15px; z-index:10;
        }
        .control-btn {
            width:60px; height:60px; border-radius:50%; border:2px solid var(--accent);
            background:rgba(26,31,58,0.9); backdrop-filter:blur(10px);
            color:var(--accent); font-size:24px; cursor:pointer; transition:all 0.3s;
            box-shadow:0 4px 20px var(--shadow); display:flex; align-items:center; justify-content:center; pointer-events:auto;
        }
        .control-btn:hover { background:rgba(0,217,255,0.2); transform:scale(1.1); box-shadow:0 0 30px rgba(0,217,255,0.5); }
        .control-btn:active { transform:scale(0.95); }
        .control-btn.active { background:var(--accent); color:var(--bg-dark); }

        /* â”€â”€ Hamburger Menu Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #menuBtn {
            position:absolute; top:calc(14px + var(--safe-top)); left:12px;
            width:46px; height:46px; border-radius:12px; border:2px solid rgba(255,107,53,0.4);
            background:rgba(26,31,58,0.85); backdrop-filter:blur(10px);
            color:var(--text); font-size:22px; cursor:pointer; z-index:20;
            display:flex; align-items:center; justify-content:center;
            box-shadow:0 4px 15px var(--shadow); pointer-events:auto;
        }

        /* â”€â”€ Side Menu Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #menuOverlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:200;
            opacity:0; pointer-events:none; transition:opacity 0.3s;
        }
        #menuOverlay.open { opacity:1; pointer-events:auto; }
        #sideMenu {
            position:fixed; top:0; left:-280px; width:280px; height:100%;
            background:rgba(15,19,51,0.97); backdrop-filter:blur(20px);
            border-right:2px solid rgba(255,107,53,0.3); z-index:201;
            padding: calc(20px + var(--safe-top)) 20px 20px;
            transition:left 0.3s cubic-bezier(0.4,0,0.2,1);
            display:flex; flex-direction:column; gap:10px;
        }
        #sideMenu.open { left:0; }
        .menu-title { font-family:'Orbitron',monospace; font-size:20px; font-weight:900; color:var(--primary); margin-bottom:20px; }
        .menu-item {
            padding:14px 18px; border-radius:12px; border:1px solid rgba(255,107,53,0.2);
            background:rgba(26,31,58,0.6); color:var(--text); font-size:17px;
            font-weight:600; cursor:pointer; display:flex; align-items:center; gap:12px;
            transition:all 0.2s;
        }
        .menu-item:hover { background:rgba(255,107,53,0.15); border-color:var(--primary); }
        .menu-item .mi-icon { font-size:22px; }

        /* â”€â”€ Next Character Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .next-character {
            position:absolute; top:calc(20px + var(--safe-top)); left:50%; transform:translateX(-50%);
            background:rgba(26,31,58,0.85); backdrop-filter:blur(10px);
            border:2px solid rgba(255,107,53,0.3); border-radius:15px;
            padding:15px 25px; display:flex; align-items:center; gap:15px;
            box-shadow:0 8px 32px var(--shadow); animation:pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%,100%{transform:translateX(-50%) scale(1)}
            50%{transform:translateX(-50%) scale(1.05)}
        }
        .next-label { font-size:14px; color:var(--text-dim); text-transform:uppercase; }
        .next-icon { width:40px; height:40px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:28px; background:rgba(255,107,53,0.2); }
        .next-type { font-family:'Orbitron',monospace; font-size:16px; font-weight:700; color:var(--accent); }

        /* â”€â”€ Start Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #startScreen {
            position:absolute; inset:0;
            background:linear-gradient(135deg,rgba(10,14,39,0.97),rgba(15,19,51,0.97));
            backdrop-filter:blur(20px); z-index:100;
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            padding:20px; animation:fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from{opacity:0}to{opacity:1} }
        .game-logo { width:110px; height:110px; border-radius:24px; object-fit:cover; margin-bottom:18px; box-shadow:0 8px 30px rgba(255,107,53,0.4); }
        .game-title {
            font-family:'Orbitron',monospace; font-size:48px; font-weight:900;
            text-align:center; margin-bottom:12px;
            background:linear-gradient(135deg,var(--primary),var(--secondary),var(--accent));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
            background-clip:text; animation:titleGlow 3s ease-in-out infinite;
        }
        @keyframes titleGlow { 0%,100%{filter:brightness(1)}50%{filter:brightness(1.3)} }
        .game-subtitle { font-size:16px; color:var(--text-dim); text-align:center; margin-bottom:14px; max-width:360px; }
        .best-score-row { font-size:14px; color:var(--text-dim); margin-bottom:30px; }
        .best-score-row span { color:var(--accent); font-family:'Orbitron',monospace; font-weight:700; }
        .difficulty-selector { display:flex; gap:12px; margin-bottom:30px; flex-wrap:wrap; justify-content:center; }
        .difficulty-btn {
            padding:13px 26px; border-radius:12px; border:2px solid var(--accent);
            background:transparent; color:var(--text);
            font-family:'Rajdhani',sans-serif; font-size:17px; font-weight:700;
            cursor:pointer; transition:all 0.3s; text-transform:uppercase;
        }
        .difficulty-btn:hover { background:rgba(0,217,255,0.1); transform:translateY(-2px); }
        .difficulty-btn.selected { background:var(--accent); color:var(--bg-dark); }
        .start-btn {
            padding:18px 55px; border-radius:50px; border:none;
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            color:var(--text); font-family:'Orbitron',monospace; font-size:22px; font-weight:900;
            cursor:pointer; transition:all 0.3s; text-transform:uppercase;
            box-shadow:0 8px 30px rgba(255,107,53,0.4); letter-spacing:2px;
        }
        .start-btn:hover { transform:translateY(-3px) scale(1.05); box-shadow:0 12px 40px rgba(255,107,53,0.6); }

        /* â”€â”€ Game Over Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #gameOverScreen {
            position:absolute; inset:0;
            background:linear-gradient(135deg,rgba(10,14,39,0.97),rgba(15,19,51,0.97));
            backdrop-filter:blur(20px); z-index:100;
            display:none; flex-direction:column; justify-content:center; align-items:center;
            padding:20px; animation:fadeIn 0.5s ease-out;
        }
        .game-over-title { font-family:'Orbitron',monospace; font-size:48px; font-weight:900; color:var(--danger); margin-bottom:10px; text-shadow:0 0 30px rgba(255,51,102,0.5); animation:shake 0.5s ease-out; }
        @keyframes shake { 0%,100%{transform:translateX(0)}25%{transform:translateX(-10px) rotate(-2deg)}75%{transform:translateX(10px) rotate(2deg)} }
        #newHighScoreMsg { font-size:20px; color:var(--secondary); margin-bottom:20px; min-height:28px; }
        .final-stats { background:rgba(26,31,58,0.8); border:2px solid rgba(255,107,53,0.3); border-radius:20px; padding:25px 35px; margin-bottom:30px; min-width:280px; }
        .stat-row { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); }
        .stat-row:last-child { border-bottom:none; }
        .stat-label { font-size:17px; color:var(--text-dim); }
        .stat-value { font-family:'Orbitron',monospace; font-size:22px; font-weight:700; color:var(--accent); }
        .restart-btn { padding:16px 48px; border-radius:50px; border:none; background:linear-gradient(135deg,var(--primary),var(--secondary)); color:var(--text); font-family:'Orbitron',monospace; font-size:18px; font-weight:900; cursor:pointer; transition:all 0.3s; text-transform:uppercase; box-shadow:0 8px 30px rgba(255,107,53,0.4); }
        .restart-btn:hover { transform:translateY(-3px) scale(1.05); }

        /* â”€â”€ Modals (Settings, Stats, Reset) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-backdrop {
            position:fixed; inset:0; background:rgba(0,0,0,0.7);
            backdrop-filter:blur(6px); z-index:300; display:none;
            align-items:center; justify-content:center; overflow-y:auto;
        }
        .modal-backdrop.open { display:flex; }
        .modal-box {
            background:rgba(15,19,51,0.97); border:2px solid rgba(255,107,53,0.35);
            border-radius:20px; padding:30px; width:340px; max-width:94vw;
            max-height:90vh; overflow-y:auto; position:relative;
            animation:modalIn 0.25s ease-out;
        }
        @keyframes modalIn { from{transform:scale(0.85);opacity:0}to{transform:scale(1);opacity:1} }
        .modal-title { font-family:'Orbitron',monospace; font-size:20px; font-weight:900; color:var(--primary); margin-bottom:22px; }
        .setting-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
        .setting-label { font-size:16px; color:var(--text); }
        /* Toggle switch */
        .toggle { position:relative; width:48px; height:26px; }
        .toggle input { opacity:0; width:0; height:0; }
        .toggle-slider { position:absolute; inset:0; background:#334; border-radius:26px; cursor:pointer; transition:0.3s; }
        .toggle-slider:before { content:''; position:absolute; height:20px; width:20px; left:3px; bottom:3px; background:white; border-radius:50%; transition:0.3s; }
        input:checked + .toggle-slider { background:var(--primary); }
        input:checked + .toggle-slider:before { transform:translateX(22px); }
        /* Select */
        .modal-select { background:rgba(26,31,58,0.9); border:1px solid rgba(255,107,53,0.3); color:var(--text); border-radius:10px; padding:8px 14px; font-size:15px; cursor:pointer; }
        .modal-select option { background:#1a1f3a; }
        .modal-btn { width:100%; padding:13px; border-radius:12px; border:none; cursor:pointer; font-size:16px; font-weight:700; margin-top:10px; transition:all 0.2s; }
        .modal-btn-primary { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; }
        .modal-btn-secondary { background:rgba(136,146,176,0.2); color:var(--text-dim); border:1px solid rgba(136,146,176,0.3); }
        .modal-btn-danger { background:rgba(255,51,102,0.15); color:var(--danger); border:1px solid rgba(255,51,102,0.3); }
        .modal-btn:hover { transform:translateY(-1px); }
        .modal-divider { height:1px; background:rgba(255,107,53,0.15); margin:16px 0; }
        /* Checkbox item */
        .check-row { display:flex; align-items:center; gap:12px; margin-bottom:12px; cursor:pointer; }
        .check-row input[type=checkbox] { width:18px; height:18px; accent-color:var(--primary); cursor:pointer; }
        .check-row label { font-size:15px; color:var(--text); cursor:pointer; }
        /* Stat row in stats modal */
        .stats-row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.07); }
        .stats-key { color:var(--text-dim); font-size:15px; }
        .stats-val { color:var(--accent); font-family:'Orbitron',monospace; font-size:16px; font-weight:700; }

        /* â”€â”€ PWA Install Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #installBanner {
            position:fixed; bottom:-200px; left:0; right:0;
            background:rgba(15,19,51,0.97); border-top:2px solid rgba(255,107,53,0.35);
            padding:18px 20px calc(18px + var(--safe-bottom));
            z-index:250; transition:bottom 0.4s cubic-bezier(0.4,0,0.2,1);
            display:flex; align-items:center; gap:14px;
        }
        #installBanner.show { bottom:0; }
        #installBanner img { width:52px; height:52px; border-radius:12px; }
        .install-text { flex:1; }
        .install-title { font-size:16px; font-weight:700; color:var(--text); margin-bottom:3px; }
        .install-desc  { font-size:13px; color:var(--text-dim); }
        #installBtn { padding:10px 20px; border-radius:12px; border:none; background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; font-weight:700; font-size:14px; cursor:pointer; white-space:nowrap; }
        #installDismissBtn { background:none; border:none; color:var(--text-dim); font-size:22px; cursor:pointer; padding:4px; }

        /* â”€â”€ Offline Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #offlineBanner {
            position:fixed; top:0; left:0; right:0;
            background:var(--danger); color:white; text-align:center;
            padding:calc(10px + var(--safe-top)) 16px 10px;
            font-size:14px; font-weight:700; z-index:400;
            transform:translateY(-100%); transition:transform 0.3s;
        }
        #offlineBanner.show { transform:translateY(0); }

        /* â”€â”€ Toast System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #toastContainer {
            position:fixed; top:calc(60px + var(--safe-top)); left:50%; transform:translateX(-50%);
            z-index:500; display:flex; flex-direction:column; align-items:center; gap:8px;
            pointer-events:none;
        }
        .toast {
            padding:12px 24px; border-radius:50px; font-size:15px; font-weight:700;
            backdrop-filter:blur(12px); box-shadow:0 4px 20px rgba(0,0,0,0.4);
            animation:toastIn 0.3s ease-out; white-space:nowrap;
        }
        .toast.info    { background:rgba(0,217,255,0.2); border:1px solid var(--accent); color:var(--accent); }
        .toast.success { background:rgba(0,255,163,0.2); border:1px solid var(--success); color:var(--success); }
        .toast.error   { background:rgba(255,51,102,0.2); border:1px solid var(--danger); color:var(--danger); }
        @keyframes toastIn { from{transform:translateY(-16px);opacity:0}to{transform:translateY(0);opacity:1} }

        /* â”€â”€ Pull-to-Refresh indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #ptr-indicator {
            position:fixed; top:calc(var(--safe-top)); left:50%; transform:translateX(-50%);
            background:rgba(26,31,58,0.9); border:1px solid rgba(255,107,53,0.3);
            border-radius:50px; padding:8px 20px; font-size:13px; color:var(--text-dim);
            z-index:50; opacity:0; pointer-events:none; transition:opacity 0.2s;
        }

        /* â”€â”€ Notification (in-game) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .notification {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            background:rgba(26,31,58,0.95); backdrop-filter:blur(10px);
            border:2px solid var(--danger); border-radius:15px;
            padding:20px 40px; font-size:24px; font-weight:700; color:var(--danger);
            z-index:200; animation:notificationPop 0.5s ease-out; pointer-events:none;
        }
        @keyframes notificationPop {
            0%{transform:translate(-50%,-50%) scale(0);opacity:0}
            50%{transform:translate(-50%,-50%) scale(1.1)}
            100%{transform:translate(-50%,-50%) scale(1);opacity:1}
        }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media(max-width:480px){
            .game-title{font-size:32px}
            .score-value{font-size:26px}
            .controls{bottom:calc(60px + var(--safe-bottom));right:10px}
            .control-btn{width:48px;height:48px;font-size:19px}
        }
    </style>
</head>
<body>

<!-- â•â•â• Offline Banner â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="offlineBanner" data-i18n="offlineBanner">No internet connection</div>

<!-- â•â•â• Toast Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toastContainer"></div>

<!-- â•â•â• Pull-to-Refresh Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="ptr-indicator">â†“ Pull to refresh</div>

<!-- â•â•â• Version Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="versionBadge" title="Click 5Ã— to hard-reset">v1.0.0</div>

<!-- â•â•â• Hamburger Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<button id="menuBtn" aria-label="Menu">â˜°</button>

<!-- â•â•â• Side Menu Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="menuOverlay"></div>
<nav id="sideMenu">
    <div class="menu-title" data-i18n="menuTitle">Menu</div>
    <div class="menu-item" id="menuNewGame"><span class="mi-icon">ğŸ®</span><span data-i18n="menuNewGame">New Game</span></div>
    <div class="menu-item" id="menuSettingsBtn"><span class="mi-icon">âš™ï¸</span><span data-i18n="menuSettings">Settings</span></div>
    <div class="menu-item" id="menuStatsBtn"><span class="mi-icon">ğŸ“Š</span><span data-i18n="menuStats">Statistics</span></div>
</nav>

<!-- â•â•â• Start Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="startScreen">
    <img src="icons/icon-192x192.png" alt="Tower Balance Logo" class="game-logo">
    <h1 class="game-title">ğŸ—ï¸ Tower Balance</h1>
    <p class="game-subtitle" data-i18n="appSubtitle">Manage center of mass, keep balance and reach a new high score!</p>
    <p class="best-score-row"><span data-i18n="bestScore">Best Score</span>: <span id="bestScoreDisplay">0</span></p>
    <div class="difficulty-selector">
        <button class="difficulty-btn"          data-difficulty="easy"   data-i18n="diffEasy">Easy</button>
        <button class="difficulty-btn selected" data-difficulty="medium" data-i18n="diffMedium">Medium</button>
        <button class="difficulty-btn"          data-difficulty="hard"   data-i18n="diffHard">Hard</button>
        <button class="difficulty-btn"          data-difficulty="expert" data-i18n="diffExpert">Expert</button>
    </div>
    <button class="start-btn" id="startBtn" data-i18n="startBtn">Start Game</button>
</div>

<!-- â•â•â• Game Over Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="gameOverScreen">
    <h1 class="game-over-title" data-i18n="gameOverTitle">Tower Collapsed!</h1>
    <p id="newHighScoreMsg"></p>
    <div class="final-stats">
        <div class="stat-row">
            <span class="stat-label" data-i18n="gameOverScore">Score</span>
            <span class="stat-value" id="finalScore">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label" data-i18n="gameOverTourists">Tourists</span>
            <span class="stat-value" id="finalTourists">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label" data-i18n="gameOverMaxAngle">Max Angle</span>
            <span class="stat-value" id="finalAngle">0Â°</span>
        </div>
    </div>
    <button class="restart-btn" id="restartBtn" data-i18n="restartBtn">Play Again</button>
</div>

<!-- â•â•â• Game Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<canvas id="gameCanvas"></canvas>

<!-- â•â•â• HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="hud">
    <div class="hud-top">
        <div class="hud-panel score-panel">
            <div class="score-label" data-i18n="hudScore">Score</div>
            <div class="score-value" id="scoreDisplay">0</div>
        </div>
        <div class="hud-panel info-panel">
            <div class="info-row">
                <span class="info-label" data-i18n="hudTurn">Turn</span>
                <span class="info-value" id="turnDisplay">1</span>
            </div>
            <div class="info-row">
                <span class="info-label" data-i18n="hudTourists">Tourists</span>
                <span class="info-value" id="touristDisplay">0</span>
            </div>
            <div class="timer-container" id="timerContainer" style="display:none">
                <div class="timer-bar" id="timerBar"></div>
            </div>
        </div>
    </div>
    <div class="next-character">
        <span class="next-label" data-i18n="hudNext">Next:</span>
        <div class="next-icon" id="nextIcon">ğŸ‘¤</div>
        <span class="next-type" id="nextType">Regular</span>
    </div>
</div>

<!-- â•â•â• Stability Meter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="stability-container">
    <div class="stability-label" data-i18n="hudStability">Stability</div>
    <div class="stability-bar-container">
        <div class="stability-bar" id="stabilityBar">
            <div class="stability-marker"></div>
        </div>
    </div>
</div>

<!-- â•â•â• Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="controls">
    <button class="control-btn" id="topViewBtn"   title="Top View">â¬‡ï¸</button>
    <button class="control-btn" id="horizonBtn"   title="Horizon View">â†”ï¸</button>
    <button class="control-btn" id="resetViewBtn" title="Reset Camera">ğŸ¯</button>
    <button class="control-btn" id="settingsHudBtn" title="Settings">âš™ï¸</button>
</div>

<!-- â•â•â• PWA Install Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="installBanner">
    <img src="icons/icon-192x192.png" alt="Icon">
    <div class="install-text">
        <div class="install-title" data-i18n="installTitle">Install App</div>
        <div class="install-desc"  data-i18n="installDesc">Install for quick access and offline play!</div>
    </div>
    <button id="installBtn" data-i18n="installBtn">Install</button>
    <button id="installDismissBtn" aria-label="Dismiss">âœ•</button>
</div>

<!-- â•â•â• Settings Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="settingsModal">
    <div class="modal-box">
        <div class="modal-title" data-i18n="settingsTitle">Settings</div>

        <div class="setting-row">
            <span class="setting-label" data-i18n="settingsLanguage">Language</span>
            <select class="modal-select" id="langSelect">
                <option value="en">English</option>
                <option value="he">×¢×‘×¨×™×ª</option>
            </select>
        </div>

        <div class="setting-row">
            <span class="setting-label" data-i18n="settingsDarkMode">Dark Mode</span>
            <label class="toggle"><input type="checkbox" id="darkModeToggle" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="setting-row">
            <span class="setting-label" data-i18n="settingsVibration">Vibration</span>
            <label class="toggle"><input type="checkbox" id="vibrationToggle" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="setting-row">
            <span class="setting-label" data-i18n="settingsSounds">Sound Effects</span>
            <label class="toggle"><input type="checkbox" id="soundToggle" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="setting-row">
            <span class="setting-label" data-i18n="settingsAnimations">Animations</span>
            <label class="toggle"><input type="checkbox" id="animToggle" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="setting-row">
            <span class="setting-label" data-i18n="settingsPullRefresh">Pull to Refresh</span>
            <label class="toggle"><input type="checkbox" id="ptrToggle"><span class="toggle-slider"></span></label>
        </div>

        <div class="modal-divider"></div>
        <button class="modal-btn modal-btn-danger" id="openResetModalBtn" data-i18n="settingsReset">Reset Data</button>
        <button class="modal-btn modal-btn-secondary" id="closeSettingsBtn" data-i18n="settingsClose">Close</button>
    </div>
</div>

<!-- â•â•â• Stats Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="statsModal">
    <div class="modal-box">
        <div class="modal-title" data-i18n="statsTitle">Statistics</div>
        <div class="stats-row"><span class="stats-key" data-i18n="statsGamesPlayed">Games Played</span><span class="stats-val" id="statGames">0</span></div>
        <div class="stats-row"><span class="stats-key" data-i18n="statsBestScore">Best Score</span><span class="stats-val" id="statBest">0</span></div>
        <div class="stats-row"><span class="stats-key" data-i18n="statsBestTourists">Most Tourists</span><span class="stats-val" id="statBestTourists">0</span></div>
        <div class="stats-row"><span class="stats-key" data-i18n="statsTotalTourists">Total Tourists</span><span class="stats-val" id="statTotal">0</span></div>
        <button class="modal-btn modal-btn-secondary" id="closeStatsBtn" style="margin-top:20px" data-i18n="statsClose">Close</button>
    </div>
</div>

<!-- â•â•â• Selective Reset Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-backdrop" id="resetModal">
    <div class="modal-box">
        <div class="modal-title" data-i18n="resetTitle">Reset Data</div>
        <p style="color:var(--text-dim);font-size:14px;margin-bottom:16px" data-i18n="resetDesc">Select what to keep before resetting:</p>
        <label class="check-row"><input type="checkbox" id="keepProgress"><label for="keepProgress" data-i18n="resetKeepProgress">Keep game progress</label></label>
        <label class="check-row"><input type="checkbox" id="keepHighScore" checked><label for="keepHighScore" data-i18n="resetKeepHighScore">Keep high scores</label></label>
        <label class="check-row"><input type="checkbox" id="keepSettings" checked><label for="keepSettings" data-i18n="resetKeepSettings">Keep settings</label></label>
        <button class="modal-btn modal-btn-danger" id="confirmResetBtn" data-i18n="resetConfirm">Reset Now</button>
        <button class="modal-btn modal-btn-secondary" id="cancelResetBtn" data-i18n="resetCancel">Cancel</button>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP VERSION & SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_VERSION = '1.0.0';

// Default settings
const DEFAULT_SETTINGS = {
    lang: 'en', darkMode: true, vibration: true,
    sound: true, animations: true, pullToRefresh: false,
};

function loadSettings() {
    try { return Object.assign({}, DEFAULT_SETTINGS, JSON.parse(localStorage.getItem('tb_settings') || '{}')); }
    catch { return { ...DEFAULT_SETTINGS }; }
}
function saveSettings(s) { localStorage.setItem('tb_settings', JSON.stringify(s)); }

let settings = loadSettings();

// â”€â”€ Version management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('versionBadge').textContent = 'v' + APP_VERSION;

// Auto-update: check if stored version differs â†’ clear cache
const storedVersion = localStorage.getItem('tb_version');
if (storedVersion && storedVersion !== APP_VERSION) {
    // New version deployed: clear caches then reload
    (async () => {
        if ('caches' in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
        }
        localStorage.setItem('tb_version', APP_VERSION);
        location.reload(true);
    })();
} else {
    localStorage.setItem('tb_version', APP_VERSION);
}

// Version badge: click 5Ã— = hard reset
let versionClicks = 0, versionTimer;
document.getElementById('versionBadge').addEventListener('click', () => {
    versionClicks++;
    clearTimeout(versionTimer);
    versionTimer = setTimeout(() => { versionClicks = 0; }, 2000);
    if (versionClicks >= 5) { versionClicks = 0; hardReset(); }
});

async function hardReset() {
    if (!confirm('Hard reset? This will erase ALL app data.')) return;
    localStorage.clear(); sessionStorage.clear();
    document.cookie.split(';').forEach(c => {
        document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/');
    });
    if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
    }
    if ('caches' in window) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
    }
    if ('indexedDB' in window) {
        const dbs = await indexedDB.databases?.() ?? [];
        dbs.forEach(db => db.name && indexedDB.deleteDatabase(db.name));
    }
    location.reload(true);
}

// â”€â”€ Service Worker + update polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
        console.log('[App] SW registered');

        // Poll for updates every 300s
        setInterval(() => reg.update(), 300_000);

        reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            newSW.addEventListener('statechange', () => {
                if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                    if (confirm(I18N.updateAvailable['en'] + '\n' + I18N.updateAvailable['he'])) {
                        newSW.postMessage({ type: 'SKIP_WAITING' });
                        location.reload();
                    }
                }
            });
        });
    }).catch(err => console.warn('[App] SW registration failed:', err));
}

// â”€â”€ Fetch version.json periodically â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkRemoteVersion() {
    try {
        const r = await fetch('./version.json?t=' + Date.now());
        const data = await r.json();
        if (data.version && data.version !== APP_VERSION) {
            showToast(t('updateAvailable'), 'info', 8000);
        }
    } catch {}
}
setTimeout(checkRemoteVersion, 5000);
setInterval(checkRemoteVersion, 300_000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LANGUAGE & THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyTheme() {
    document.body.classList.toggle('light-mode', !settings.darkMode);
}

function initSettings() {
    applyTranslations(settings.lang);
    applyTheme();
    document.getElementById('langSelect').value = settings.lang;
    document.getElementById('darkModeToggle').checked = settings.darkMode;
    document.getElementById('vibrationToggle').checked = settings.vibration;
    document.getElementById('soundToggle').checked = settings.sound;
    document.getElementById('animToggle').checked = settings.animations;
    document.getElementById('ptrToggle').checked = settings.pullToRefresh;
    document.body.style.transition = settings.animations ? '' : 'none';
}

document.getElementById('langSelect').addEventListener('change', e => {
    settings.lang = e.target.value;
    saveSettings(settings);
    applyTranslations(settings.lang);
    document.documentElement.dir = settings.lang === 'he' ? 'rtl' : 'ltr';
    updateNextCharDisplay();
});
document.getElementById('darkModeToggle').addEventListener('change',  e => { settings.darkMode   = e.target.checked; saveSettings(settings); applyTheme(); });
document.getElementById('vibrationToggle').addEventListener('change', e => { settings.vibration  = e.target.checked; saveSettings(settings); });
document.getElementById('soundToggle').addEventListener('change',     e => { settings.sound       = e.target.checked; saveSettings(settings); });
document.getElementById('animToggle').addEventListener('change',      e => { settings.animations  = e.target.checked; saveSettings(settings); document.body.style.transition = e.target.checked ? '' : 'none'; });
document.getElementById('ptrToggle').addEventListener('change',       e => { settings.pullToRefresh = e.target.checked; saveSettings(settings); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(message, type = 'info', duration = 2500) {
    const container = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = message;
    container.appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 0.3s'; setTimeout(() => el.remove(), 350); }, duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OFFLINE / ONLINE MONITORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const offlineBanner = document.getElementById('offlineBanner');
window.addEventListener('offline', () => { offlineBanner.classList.add('show'); });
window.addEventListener('online',  () => {
    offlineBanner.classList.remove('show');
    showToast(t('onlineToast'), 'success');
});
if (!navigator.onLine) offlineBanner.classList.add('show');

// Data saver / slow connection
if ('connection' in navigator) {
    const conn = navigator.connection;
    const checkConn = () => {
        if (conn.saveData || conn.effectiveType === '2g' || conn.effectiveType === 'slow-2g') {
            showToast(t('slowConnectionToast'), 'info', 5000);
        }
    };
    conn.addEventListener('change', checkConn);
    checkConn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA INSTALL BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredInstallPrompt = null;
const installBanner = document.getElementById('installBanner');

window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    if (localStorage.getItem('tb_install_dismissed')) return;
    deferredInstallPrompt = e;
    setTimeout(() => installBanner.classList.add('show'), 3000);
});

document.getElementById('installBtn').addEventListener('click', async () => {
    if (!deferredInstallPrompt) return;
    deferredInstallPrompt.prompt();
    const { outcome } = await deferredInstallPrompt.userChoice;
    deferredInstallPrompt = null;
    installBanner.classList.remove('show');
    if (outcome === 'accepted') showToast(t('toastInstalled'), 'success', 3000);
});

document.getElementById('installDismissBtn').addEventListener('click', () => {
    installBanner.classList.remove('show');
    localStorage.setItem('tb_install_dismissed', '1');
});

window.addEventListener('appinstalled', () => {
    installBanner.classList.remove('show');
    showToast(t('toastInstalled'), 'success', 3000);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HAMBURGER MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const menuOverlay = document.getElementById('menuOverlay');
const sideMenu    = document.getElementById('sideMenu');

function openMenu()  { sideMenu.classList.add('open'); menuOverlay.classList.add('open'); document.body.style.overflow = 'hidden'; }
function closeMenu() { sideMenu.classList.remove('open'); menuOverlay.classList.remove('open'); document.body.style.overflow = ''; }

document.getElementById('menuBtn').addEventListener('click', openMenu);
menuOverlay.addEventListener('click', closeMenu);

document.getElementById('menuNewGame').addEventListener('click', () => {
    closeMenu();
    document.getElementById('startScreen').style.display = 'flex';
});
document.getElementById('menuSettingsBtn').addEventListener('click', () => { closeMenu(); openModal('settingsModal'); });
document.getElementById('menuStatsBtn').addEventListener('click',    () => { closeMenu(); openStatsModal(); });

// Settings from HUD
document.getElementById('settingsHudBtn').addEventListener('click', () => openModal('settingsModal'));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) {
    document.getElementById(id).classList.add('open');
    document.body.style.overflow = 'hidden';
}
function closeModal(id) {
    document.getElementById(id).classList.remove('open');
    document.body.style.overflow = '';
}

document.getElementById('closeSettingsBtn').addEventListener('click', () => closeModal('settingsModal'));
document.getElementById('closeStatsBtn').addEventListener('click',    () => closeModal('statsModal'));
document.getElementById('cancelResetBtn').addEventListener('click',   () => closeModal('resetModal'));

document.getElementById('openResetModalBtn').addEventListener('click', () => {
    closeModal('settingsModal');
    openModal('resetModal');
});

document.getElementById('confirmResetBtn').addEventListener('click', async () => {
    const keepProgress  = document.getElementById('keepProgress').checked;
    const keepHighScore = document.getElementById('keepHighScore').checked;
    const keepSettingsC = document.getElementById('keepSettings').checked;

    const progress  = keepProgress  ? localStorage.getItem('tb_gamestate') : null;
    const highScore = keepHighScore ? localStorage.getItem('tb_stats')     : null;
    const sett      = keepSettingsC ? localStorage.getItem('tb_settings')  : null;

    localStorage.clear();
    if (progress)  localStorage.setItem('tb_gamestate', progress);
    if (highScore) localStorage.setItem('tb_stats',     highScore);
    if (sett)      localStorage.setItem('tb_settings',  sett);
    localStorage.setItem('tb_version', APP_VERSION);

    // Unregister SW & clear caches
    if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
    }
    if ('caches' in window) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
    }

    closeModal('resetModal');
    showToast(t('toastResetDone'), 'success');
    setTimeout(() => location.reload(true), 800);
});

// Stats modal
function openStatsModal() {
    const stats = loadStats();
    document.getElementById('statGames').textContent        = stats.gamesPlayed  || 0;
    document.getElementById('statBest').textContent         = stats.bestScore    || 0;
    document.getElementById('statBestTourists').textContent = stats.bestTourists || 0;
    document.getElementById('statTotal').textContent        = stats.totalTourists|| 0;
    openModal('statsModal');
}

// Close modals on backdrop click
['settingsModal','statsModal','resetModal'].forEach(id => {
    document.getElementById(id).addEventListener('click', e => {
        if (e.target === e.currentTarget) closeModal(id);
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATISTICS (localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadStats() {
    try { return JSON.parse(localStorage.getItem('tb_stats') || '{}'); }
    catch { return {}; }
}
function saveStats(s) { localStorage.setItem('tb_stats', JSON.stringify(s)); }
function updateStats(score, tourists) {
    const s = loadStats();
    s.gamesPlayed   = (s.gamesPlayed   || 0) + 1;
    s.bestScore     = Math.max(s.bestScore    || 0, score);
    s.bestTourists  = Math.max(s.bestTourists || 0, tourists);
    s.totalTourists = (s.totalTourists || 0) + tourists;
    saveStats(s);
    return s;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PULL-TO-REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ptrStartY = 0, ptrActive = false;
const ptrIndicator = document.getElementById('ptr-indicator');

document.addEventListener('touchstart', e => {
    if (!settings.pullToRefresh) return;
    if (window.scrollY === 0) ptrStartY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchmove', e => {
    if (!settings.pullToRefresh || !ptrStartY) return;
    const delta = e.touches[0].clientY - ptrStartY;
    if (delta > 60) {
        ptrIndicator.style.opacity = '1';
        ptrActive = true;
    }
}, { passive: true });

document.addEventListener('touchend', () => {
    if (!settings.pullToRefresh) return;
    if (ptrActive) { ptrActive = false; ptrIndicator.style.opacity = '0'; location.reload(); }
    ptrStartY = 0;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWIPE GESTURES (close modals / side menu on swipe down/left)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let swipeStartX = 0, swipeStartY = 0;
document.addEventListener('touchstart', e => {
    swipeStartX = e.touches[0].clientX;
    swipeStartY = e.touches[0].clientY;
}, { passive: true });

document.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - swipeStartX;
    const dy = e.changedTouches[0].clientY - swipeStartY;
    // Swipe right â†’ open menu; swipe left â†’ close menu
    if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy) * 1.5) {
        if (dx > 0 && swipeStartX < 40) openMenu();
        if (dx < 0) closeMenu();
    }
    // Swipe down â†’ close floating modals
    if (dy > 80 && Math.abs(dy) > Math.abs(dx) * 1.5) {
        ['settingsModal','statsModal','resetModal'].forEach(id => {
            if (document.getElementById(id).classList.contains('open')) closeModal(id);
        });
    }
}, { passive: true });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HAPTIC FEEDBACK HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function vibrate(pattern) {
    if (settings.vibration && navigator.vibrate) navigator.vibrate(pattern);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
    physics: {
        gravity: 9.81, maxAngle: 45,
        damping: 0.95, restitution: 0.15,
        friction: 0.7, slideFrictionAngle: 15,
    },
    tower: { baseWidth: 80, floorHeight: 60, floorCount: 8, maxPerFloor: 4 },
    characters: {
        types: {
            standard: { mass: 1,   size: 20, icon: 'ğŸ§', color: '#4a9eff' },
            heavy:    { mass: 2,   size: 25, icon: 'ğŸ‹ï¸', color: '#ff4a4a' },
            child:    { mass: 0.5, size: 15, icon: 'ğŸ‘¶', color: '#ffd700' },
        },
    },
    difficulty: {
        easy:   { timer: false, wind: false, friction: 0.8 },
        medium: { timer: true,  timerDuration: 15, wind: false, friction: 0.7 },
        hard:   { timer: true,  timerDuration: 10, wind: true,  windInterval: 10, friction: 0.6 },
        expert: { timer: true,  timerDuration: 8,  wind: true,  windInterval: 5,  friction: 0.5 },
    },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class GameState {
    constructor() { this.reset(); this.difficulty = 'medium'; }
    reset() { this.score = 0; this.turn = 1; this.tourists = 0; this.maxAngle = 0; this.gameOver = false; this.paused = false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class PhysicsEngine {
    constructor(config) { this.config = config; this.reset(); }
    reset() { this.angle = 0; this.angularVelocity = 0; this.angularAcceleration = 0; this.momentOfInertia = 1000; this.windForce = { x: 0, y: 0 }; }

    calculateCenterOfMass(characters) {
        if (!characters.length) return { x: 0, y: 0, totalMass: 0 };
        let totalMass = 0, comX = 0, comY = 0;
        characters.forEach(c => { totalMass += c.mass; comX += c.mass * c.x; comY += c.mass * c.y; });
        return { x: comX / totalMass, y: comY / totalMass, totalMass };
    }

    update(dt, characters) {
        // Characters are stored in tower-local coordinates (x=0 is pivot).
        // Torque = r Ã— F where r is horizontal offset from pivot and F = mass Ã— gravity_scale.
        // gravity_scale is intentionally small so the tower tilts gradually, not instantly.
        const GRAVITY_SCALE = 0.08; // tuned for gameplay feel
        const com = this.calculateCenterOfMass(characters);
        const r = com.x; // already relative to pivot (tower center)
        const torque = r * com.totalMass * GRAVITY_SCALE + this.windForce.x * 0.5;
        // Moment of inertia scales with number of characters so heavier towers resist better
        const I = 500 + characters.length * 120;
        this.angularAcceleration = torque / I;
        this.angularVelocity += this.angularAcceleration * dt;
        this.angularVelocity *= this.config.damping;
        this.angle += this.angularVelocity * dt;
        // Clamp to prevent runaway
        this.angularVelocity = Math.max(-2, Math.min(2, this.angularVelocity));
        return Math.abs(this.angle) > (this.config.maxAngle * Math.PI) / 180;
    }

    applyWind() { this.windForce.x = (Math.random() - 0.5) * 2; }
    getAngleDegrees() { return (this.angle * 180) / Math.PI; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARACTER CLASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Character {
    constructor(type, x, y, floor) {
        const ct = CONFIG.characters.types[type];
        Object.assign(this, { type, mass: ct.mass, size: ct.size, icon: ct.icon, color: ct.color, x, y, floor, isSliding: false, velocity: { x: 0, y: 0 } });
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y);
        ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(0, 0, this.size, 0, Math.PI * 2); ctx.fill();
        ctx.font = `${this.size * 1.2}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(this.icon, 0, 0);
        ctx.restore();
    }
    checkSliding(towerAngle) {
        const crit = (CONFIG.physics.slideFrictionAngle * Math.PI) / 180;
        if (Math.abs(towerAngle) > crit) { this.isSliding = true; this.velocity.x += CONFIG.physics.gravity * Math.sin(towerAngle) * 0.016; }
    }
    update(dt) { if (this.isSliding) { this.x += this.velocity.x * dt; this.velocity.x *= CONFIG.physics.friction; } }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOWER CLASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Tower {
    constructor(canvas) {
        this.canvas = canvas;
        this.baseX = canvas.width / 2; this.baseY = canvas.height - 100;
        this.floors = [];
        this.initFloors();
    }
    initFloors() {
        this.floors = [];
        for (let i = 0; i < CONFIG.tower.floorCount; i++) {
            this.floors.push({ y: -(i + 1) * CONFIG.tower.floorHeight, characters: [] });
        }
    }
    draw(ctx, angle) {
        ctx.save(); ctx.translate(this.baseX, this.baseY); ctx.rotate(angle);
        ctx.fillStyle = '#ff6b35'; ctx.fillRect(-CONFIG.tower.baseWidth / 2, 0, CONFIG.tower.baseWidth, 20);
        this.floors.forEach((floor, i) => {
            const fy = -(i + 1) * CONFIG.tower.floorHeight;
            ctx.fillStyle = '#f7931e'; ctx.fillRect(-CONFIG.tower.baseWidth / 2, fy, CONFIG.tower.baseWidth, 10);
            ctx.strokeStyle = '#00d9ff'; ctx.lineWidth = 2; ctx.strokeRect(-CONFIG.tower.baseWidth / 2, fy, CONFIG.tower.baseWidth, 10);
        });
        ctx.strokeStyle = '#8892b0'; ctx.lineWidth = 3; ctx.beginPath();
        ctx.moveTo(-CONFIG.tower.baseWidth / 2 + 5, 0); ctx.lineTo(-CONFIG.tower.baseWidth / 2 + 5, -CONFIG.tower.floorCount * CONFIG.tower.floorHeight);
        ctx.moveTo( CONFIG.tower.baseWidth / 2 - 5, 0); ctx.lineTo( CONFIG.tower.baseWidth / 2 - 5, -CONFIG.tower.floorCount * CONFIG.tower.floorHeight);
        ctx.stroke(); ctx.restore();
    }
    addCharacter(character, floorIndex) {
        if (floorIndex < 0 || floorIndex >= this.floors.length) return false;
        const floor = this.floors[floorIndex];
        if (floor.characters.length >= CONFIG.tower.maxPerFloor) floor.characters.shift();
        floor.characters.push(character); return true;
    }
    getAllCharacters() { return this.floors.flatMap(f => f.characters); }
    reset() { this.floors.forEach(f => f.characters = []); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME CLASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.resizeCanvas();

        this.state   = new GameState();
        this.physics = new PhysicsEngine(CONFIG.physics);
        this.tower   = new Tower(this.canvas);

        this.nextCharType = this.randomCharType();
        this.dragCharacter = null;
        this.ghostPreview  = null;
        this.timer = 0; this.windTimer = 0;
        this.cameraMode = 'default';
        this.lastTimestamp = null;
        this.loopRunning = false;

        // Watchdog: detect stall
        this._lastDrawTime = Date.now();
        setInterval(() => {
            if (this.loopRunning && Date.now() - this._lastDrawTime > 3000) {
                console.warn('[Watchdog] Canvas stall detected â€“ reinitializing');
                this._lastDrawTime = Date.now();
                this.lastTimestamp = null;
                requestAnimationFrame(t => this.loop(t));
            }
        }, 3000);

        this.setupEvents();
        window.addEventListener('resize', () => { this.resizeCanvas(); this.tower.baseX = this.canvas.width / 2; this.tower.baseY = this.canvas.height - 100; });
    }

    resizeCanvas() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; }

    setupEvents() {
        // Mouse
        this.canvas.addEventListener('mousedown',  e => this.handleStart(e));
        this.canvas.addEventListener('mousemove',  e => this.handleMove(e));
        this.canvas.addEventListener('mouseup',    e => this.handleEnd(e));
        // Touch
        this.canvas.addEventListener('touchstart', e => { e.preventDefault(); this.handleStart(e.touches[0]); }, { passive: false });
        this.canvas.addEventListener('touchmove',  e => { e.preventDefault(); this.handleMove(e.touches[0]); },  { passive: false });
        this.canvas.addEventListener('touchend',   e => { e.preventDefault(); this.handleEnd(e); },              { passive: false });
        // Camera
        document.getElementById('topViewBtn').addEventListener('click',   () => this.setCamera('top'));
        document.getElementById('horizonBtn').addEventListener('click',   () => this.setCamera('horizon'));
        document.getElementById('resetViewBtn').addEventListener('click', () => this.setCamera('default'));
    }

    handleStart(e) {
        if (this.state.gameOver || this.dragCharacter) return;
        const r = this.canvas.getBoundingClientRect();
        this.dragCharacter = new Character(this.nextCharType, e.clientX - r.left, e.clientY - r.top, -1);
        vibrate(10);
    }

    handleMove(e) {
        if (!this.dragCharacter) return;
        const r = this.canvas.getBoundingClientRect();
        this.dragCharacter.x = e.clientX - r.left;
        this.dragCharacter.y = e.clientY - r.top;
        this.updateGhost(this.dragCharacter.x, this.dragCharacter.y);
    }

    handleEnd(e) {
        if (!this.dragCharacter) return;
        const fi = this.getFloorAt(this.dragCharacter.y);
        if (fi >= 0) {
            this.dragCharacter.x = this.dragCharacter.x - this.tower.baseX;
            this.dragCharacter.y = this.tower.floors[fi].y;
            this.dragCharacter.floor = fi;
            this.tower.addCharacter(this.dragCharacter, fi);
            this.state.tourists++; this.state.score += Math.floor(this.dragCharacter.mass * 10); this.state.turn++;
            this.timer = 0;
            this.nextCharType = this.randomCharType();
            this.updateNextCharDisplay();
            this.updateHUD();
            this.saveState();
            vibrate(20);
        } else {
            vibrate([50, 30, 50]);
        }
        this.dragCharacter = null; this.ghostPreview = null;
    }

    updateGhost(x, y) {
        const fi = this.getFloorAt(y);
        if (fi >= 0) {
            this.ghostPreview = { x, y: this.tower.floors[fi].y + this.tower.baseY, valid: this.tower.floors[fi].characters.length < CONFIG.tower.maxPerFloor };
        } else { this.ghostPreview = null; }
    }

    getFloorAt(y) {
        for (let i = 0; i < this.tower.floors.length; i++) {
            if (Math.abs(y - (this.tower.floors[i].y + this.tower.baseY)) < 40) return i;
        }
        return -1;
    }

    randomCharType() {
        if (this.state.turn % 5 === 0) return 'heavy';
        return Math.random() < 0.2 ? 'child' : 'standard';
    }

    updateNextCharDisplay() {
        const ct = CONFIG.characters.types[this.nextCharType];
        document.getElementById('nextIcon').textContent = ct.icon;
        const keyMap = { standard: 'hudCharNormal', heavy: 'hudCharHeavy', child: 'hudCharLight' };
        document.getElementById('nextType').textContent = t(keyMap[this.nextCharType] || 'hudCharNormal');
    }

    setCamera(mode) {
        this.cameraMode = mode;
        document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
        if (mode === 'top')     document.getElementById('topViewBtn').classList.add('active');
        if (mode === 'horizon') document.getElementById('horizonBtn').classList.add('active');
    }

    update(dt) {
        if (this.state.gameOver || this.state.paused) return;
        const dc = CONFIG.difficulty[this.state.difficulty];
        if (dc.timer) {
            this.timer += dt;
            if (this.timer >= dc.timerDuration) { this.forceSpawn(); this.timer = 0; }
            this.updateTimerDisplay();
        }
        if (dc.wind) { this.windTimer += dt; if (this.windTimer >= dc.windInterval) { this.physics.applyWind(); this.windTimer = 0; } }

        const chars = this.tower.getAllCharacters();
        if (this.physics.update(dt, chars)) { this.gameOver(); return; }
        const ang = Math.abs(this.physics.getAngleDegrees());
        if (ang > this.state.maxAngle) this.state.maxAngle = ang;
        chars.forEach(c => { c.checkSliding(this.physics.angle); c.update(dt); });
        this.updateStabilityDisplay();
    }

    forceSpawn() {
        const type = this.randomCharType();
        const fi   = Math.floor(Math.random() * this.tower.floors.length);
        const x    = (Math.random() - 0.5) * CONFIG.tower.baseWidth * 0.8;
        const char = new Character(type, x, this.tower.floors[fi].y, fi);
        this.tower.addCharacter(char, fi);
        this.state.tourists++; this.state.turn++;
        this.nextCharType = this.randomCharType();
        this.updateNextCharDisplay(); this.updateHUD();
    }

    draw() {
        this._lastDrawTime = Date.now();
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.save();
        if (this.cameraMode === 'top') {
            this.ctx.translate(this.canvas.width / 2, this.canvas.height / 2);
            this.ctx.scale(0.8, 0.4);
            this.ctx.translate(-this.canvas.width / 2, -this.canvas.height / 2);
        }
        this.tower.draw(this.ctx, this.physics.angle);
        this.ctx.save();
        this.ctx.translate(this.tower.baseX, this.tower.baseY);
        this.ctx.rotate(this.physics.angle);
        this.tower.getAllCharacters().forEach(c => c.draw(this.ctx));
        this.ctx.restore();

        if (this.ghostPreview) {
            this.ctx.fillStyle = this.ghostPreview.valid ? 'rgba(0,255,163,0.3)' : 'rgba(255,51,102,0.3)';
            this.ctx.beginPath(); this.ctx.arc(this.ghostPreview.x, this.ghostPreview.y, 25, 0, Math.PI * 2); this.ctx.fill();
            if (!this.ghostPreview.valid) {
                this.ctx.strokeStyle = '#ff3366'; this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.moveTo(this.ghostPreview.x - 15, this.ghostPreview.y - 15); this.ctx.lineTo(this.ghostPreview.x + 15, this.ghostPreview.y + 15);
                this.ctx.moveTo(this.ghostPreview.x + 15, this.ghostPreview.y - 15); this.ctx.lineTo(this.ghostPreview.x - 15, this.ghostPreview.y + 15);
                this.ctx.stroke();
            }
        }
        if (this.dragCharacter) this.dragCharacter.draw(this.ctx);
        if (this.cameraMode === 'top') {
            const com = this.physics.calculateCenterOfMass(this.tower.getAllCharacters());
            this.ctx.fillStyle = '#00d9ff'; this.ctx.beginPath(); this.ctx.arc(this.tower.baseX + com.x, this.tower.baseY, 8, 0, Math.PI * 2); this.ctx.fill();
        }
        this.ctx.restore();
    }

    updateHUD() {
        document.getElementById('scoreDisplay').textContent   = this.state.score;
        document.getElementById('turnDisplay').textContent    = this.state.turn;
        document.getElementById('touristDisplay').textContent = this.state.tourists;
    }
    updateTimerDisplay() {
        const p = (this.timer / CONFIG.difficulty[this.state.difficulty].timerDuration) * 100;
        document.getElementById('timerBar').style.width = p + '%';
    }
    updateStabilityDisplay() {
        const p = ((this.physics.getAngleDegrees() / CONFIG.physics.maxAngle) * 50) + 50;
        document.getElementById('stabilityBar').style.marginLeft = p + '%';
    }

    // â”€â”€ Auto-save / load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    saveState() {
        const snapshot = {
            score: this.state.score, turn: this.state.turn,
            tourists: this.state.tourists, maxAngle: this.state.maxAngle,
            difficulty: this.state.difficulty, nextCharType: this.nextCharType,
            timestamp: Date.now(),
        };
        localStorage.setItem('tb_gamestate', JSON.stringify(snapshot));
    }

    gameOver() {
        this.state.gameOver = true;
        const stats = updateStats(this.state.score, this.state.tourists);
        document.getElementById('finalScore').textContent    = this.state.score;
        document.getElementById('finalTourists').textContent = this.state.tourists;
        document.getElementById('finalAngle').textContent    = `${this.state.maxAngle.toFixed(1)}Â°`;
        const isNewHS = this.state.score >= stats.bestScore;
        document.getElementById('newHighScoreMsg').textContent = isNewHS ? t('newHighScore') : '';
        document.getElementById('gameOverScreen').style.display = 'flex';
        document.getElementById('bestScoreDisplay').textContent = stats.bestScore;
        vibrate([200, 100, 200]);
        localStorage.removeItem('tb_gamestate');
    }

    start() {
        this.state.reset(); this.physics.reset(); this.tower.reset();
        this.timer = 0; this.windTimer = 0;
        this.nextCharType = this.randomCharType();
        this.updateNextCharDisplay(); this.updateHUD();
        const dc = CONFIG.difficulty[this.state.difficulty];
        document.getElementById('timerContainer').style.display = dc.timer ? 'block' : 'none';
    }

    loop(timestamp) {
        this.loopRunning = true;
        if (!this.lastTimestamp) this.lastTimestamp = timestamp;
        const dt = Math.min((timestamp - this.lastTimestamp) / 1000, 0.033);
        this.lastTimestamp = timestamp;
        this.update(dt);
        this.draw();
        requestAnimationFrame(t => this.loop(t));
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let game;

// Load best score
document.getElementById('bestScoreDisplay').textContent = loadStats().bestScore || 0;

document.getElementById('startBtn').addEventListener('click', () => {
    const diff = document.querySelector('.difficulty-btn.selected').dataset.difficulty;
    if (!game) game = new Game();
    game.state.difficulty = diff;
    game.start();
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('gameOverScreen').style.display = 'none';
    requestAnimationFrame(t => game.loop(t));
    vibrate(30);
});

document.getElementById('restartBtn').addEventListener('click', () => {
    document.getElementById('gameOverScreen').style.display = 'none';
    game.start();
    vibrate(30);
});

document.querySelectorAll('.difficulty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    });
});

// Helper so language switch updates next-char display
function updateNextCharDisplay() { if (game) game.updateNextCharDisplay(); }

// Apply settings on init
initSettings();
</script>
</body>
</html>
